require('dotenv').config();const express=require('express');const bodyParser=require('body-parser');const axios=require('axios');const path=require('path');const crypto=require('crypto');const{registrarAccion,obtenerRegistrosUsuario,obtenerRegistrosMes,obtenerResumenMensual,crearUsuario,obtenerUsuarioPorToken,obtenerTodosUsuarios}=require('./database');const{isInCompanyWiFi,getClientIP}=require('./wifi-validator');const app=express();app.use(bodyParser.json());app.use(bodyParser.urlencoded({extended:true}));app.use(express.static(path.join(__dirname,'public')));const WHATSAPP_TOKEN=process.env.WHATSAPP_TOKEN;const PHONE_NUMBER_ID=process.env.PHONE_NUMBER_ID;const WEBHOOK_VERIFY_TOKEN=process.env.WEBHOOK_VERIFY_TOKEN;const ADMIN_USER=process.env.ADMIN_USER||'admin';const ADMIN_PASS=process.env.ADMIN_PASS||'admin123';app.get('/',(q,s)=>s.redirect('/admin/login'));app.get('/admin/login',(q,s)=>s.sendFile(path.join(__dirname,'public','admin','login.html')));app.get('/admin/dashboard',(q,s)=>s.sendFile(path.join(__dirname,'public','admin','dashboard.html')));app.get('/e/:token',(q,s)=>s.sendFile(path.join(__dirname,'public','empleado','fichar.html')));app.post('/api/admin/login',(q,s)=>{const{usuario,password}=q.body;usuario===ADMIN_USER&&password===ADMIN_PASS?s.json({ok:true,message:'Login exitoso'}):s.status(401).json({ok:false,error:'Credenciales inválidas'})});app.post('/api/admin/crear-empleado',async(q,s)=>{const{nombre,telefono,email}=q.body;if(!nombre||!telefono)return s.status(400).json({ok:false,error:'Faltan datos'});const token=crypto.randomBytes(16).toString('hex');crearUsuario(telefono,nombre,email,token,(e,u)=>{if(e){console.error('Error:',e);return s.status(500).json({ok:false,error:'Error al crear usuario'})}const linkAcceso=`${q.protocol}://${q.get('host')}/e/${token}`;const mensaje=`Hola ${nombre},\n\nTu acceso a A DIARIO:\n${linkAcceso}\n\nGuarda este link.`;sendWhatsAppMessage(telefono,mensaje);s.json({ok:true,usuario:{nombre,telefono,token,linkAcceso}})})});app.get('/api/admin/empleados',(q,s)=>{obtenerTodosUsuarios((e,u)=>e?s.status(500).json({ok:false,error:'Error'}):s.json({ok:true,usuarios:u}))});app.get('/api/empleado/verificar/:token',(q,s)=>{obtenerUsuarioPorToken(q.params.token,(e,u)=>e||!u?s.status(404).json({ok:false,error:'Token inválido'}):s.json({ok:true,usuario:{nombre:u.nombre,telefono:u.telefono}}))});app.get('/api/wifi',(q,s)=>{const ip=getClientIP(q);const allowed=isInCompanyWiFi(ip);s.json({allowed,ip})});app.post('/api/fichar',(q,s)=>{const{tipo,token}=q.body;const clientIP=getClientIP(q);if(!token)return s.status(400).json({ok:false,error:'Token requerido'});obtenerUsuarioPorToken(token,(e,u)=>{if(e||!u)return s.status(404).json({ok:false,error:'Token inválido'});const telefono=u.telefono;if(tipo!=='ENTRAR'&&tipo!=='SALIR')return s.status(400).json({ok:false,error:'Tipo inválido'});if(!isInCompanyWiFi(clientIP))return s.json({ok:false,error:'Debes estar en WiFi empresa',requiresWifi:true});registrarAccion(telefono,tipo,clientIP,(e,r)=>{if(e){console.error('Error:',e);return s.status(500).json({ok:false,error:'Error al registrar'})}const fecha=new Date(r.fecha_hora).toLocaleString('es-ES');s.json({ok:true,tipo,fecha,ip:clientIP})})})});app.get('/api/hoy/:token',(q,s)=>{obtenerUsuarioPorToken(q.params.token,(e,u)=>{if(e||!u)return s.status(404).json({ok:false,error:'Token inválido'});const hoy=new Date().toISOString().split('T')[0];obtenerRegistrosUsuario(u.telefono,null,(e,r)=>{if(e)return s.status(500).json({registros:[],error:'Error'});const registrosHoy=r.filter(x=>x.fecha_hora.startsWith(hoy)).map(x=>({tipo:x.accion,hora:new Date(x.fecha_hora).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}));s.json({registros:registrosHoy})})})});
app.get('/webhook',(q,s)=>{const mode=q.query['hub.mode'];const token=q.query['hub.verify_token'];const challenge=q.query['hub.challenge'];mode==='subscribe'&&token===WEBHOOK_VERIFY_TOKEN?(console.log('✅ Webhook verificado'),s.status(200).send(challenge)):s.sendStatus(403)});app.post('/webhook',async(q,s)=>{try{const body=q.body;if(body.object==='whatsapp_business_account'){body.entry.forEach(e=>{e.changes.forEach(c=>{if(c.value.messages){const message=c.value.messages[0];const from=message.from;const text=message.text.body.toUpperCase().trim();console.log(`📱 Mensaje de ${from}: ${text}`);procesarComando(from,text,q)}})})}s.sendStatus(200)}catch(error){console.error('❌ Error:',error);s.sendStatus(500)}});function procesarComando(t,c,q){if(c==='ENTRAR'||c==='SALIR'){const clientIP=getClientIP(q);console.log(`🔍 Fichaje - ${t}, IP: ${clientIP}, ${c}`);if(!isInCompanyWiFi(clientIP)){const mensaje='🚫 *Fichaje bloqueado*\\n\\nSolo desde WiFi empresa.\\n\\n'+`Tu IP: ${clientIP}\\nConéctate al WiFi.`;sendWhatsAppMessage(t,mensaje);console.log(`🚫 RECHAZADO - ${t}`);return}registrarAccion(t,c,clientIP,(e,r)=>{if(e){console.error('Error:',e);sendWhatsAppMessage(t,'❌ Error al registrar.');return}const fecha=new Date(r.fecha_hora).toLocaleString('es-ES');const emoji=c==='ENTRAR'?'✅':'🚪';const mensaje=`${emoji} *${c}* registrado\\n📅 ${fecha}\\n📍 IP: ${clientIP}`;sendWhatsAppMessage(t,mensaje);console.log(`✅ EXITOSO - ${t} - ${c}`)})}else if(c==='WIFI'){const clientIP=getClientIP(q);const enRed=isInCompanyWiFi(clientIP);const emoji=enRed?'✅':'❌';const estado=enRed?'conectado':'NO conectado';const mensaje=`${emoji} *Estado WiFi*\\n\\nEstás ${estado} a la red.\\n\\nIP: ${clientIP}`;sendWhatsAppMessage(t,mensaje)}else if(c==='CONSULTA'){consultarRegistrosHoy(t)}else if(c.startsWith('MES ')){const mes=c.replace('MES ','').trim();consultarRegistrosMes(t,mes)}else if(c==='AYUDA'){enviarAyuda(t)}else{sendWhatsAppMessage(t,'❓ Comando no reconocido. *AYUDA*')}}function consultarRegistrosHoy(t){const hoy=new Date().toISOString().split('T')[0];obtenerRegistrosUsuario(t,null,(e,r)=>{if(e){sendWhatsAppMessage(t,'❌ Error.');return}const registrosHoy=r.filter(x=>x.fecha_hora.startsWith(hoy));if(registrosHoy.length===0){sendWhatsAppMessage(t,'📋 Sin registros hoy.');return}let mensaje='📋 *Registros hoy:*\\n\\n';registrosHoy.forEach(x=>{const hora=new Date(x.fecha_hora).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});mensaje+=`${x.accion==='ENTRAR'?'✅':'🚪'} ${x.accion} - ${hora}\\n`});sendWhatsAppMessage(t,mensaje)})}function consultarRegistrosMes(t,m){obtenerRegistrosUsuario(t,m,(e,r)=>{if(e||r.length===0){sendWhatsAppMessage(t,`📋 Sin registros en ${m}`);return}let mensaje=`📋 *Registros ${m}:*\\n\\n`;r.slice(0,10).forEach(x=>{const fecha=new Date(x.fecha_hora).toLocaleDateString('es-ES');mensaje+=`${x.accion==='ENTRAR'?'✅':'🚪'} ${x.accion} - ${fecha}\\n`});mensaje+=`\\n📊 Total: ${r.length}`;sendWhatsAppMessage(t,mensaje)})}function enviarAyuda(t){const mensaje=`🤖 *A DIARIO*\n*Comandos:*\n✅ *ENTRAR*\n🚪 *SALIR*\n📋 *CONSULTA*\n📅 *MES 2025-12*\n📶 *WIFI*\n❓ *AYUDA*\n⚠️ Solo WiFi empresa`.trim();sendWhatsAppMessage(t,mensaje)}async function sendWhatsAppMessage(to,text){try{await axios.post(`https://graph.facebook.com/v21.0/${PHONE_NUMBER_ID}/messages`,{messaging_product:'whatsapp',to:to,text:{body:text}},{headers:{'Authorization':`Bearer ${WHATSAPP_TOKEN}`,'Content-Type':'application/json'}});console.log(`✉️ Mensaje a ${to}`)}catch(error){console.error('❌ Error:',error.response?.data||error.message)}}const PORT=process.env.PORT||3000;app.listen(PORT,()=>{console.log(`🚀 A DIARIO en puerto ${PORT}`);console.log(`🔒 WiFi: ${process.env.ALLOWED_IPS}`)});
app.get('/webhook',(q,s)=>{const mode=q.query['hub.mode'];const token=q.query['hub.verify_token'];const challenge=q.query['hub.challenge'];mode==='subscribe'&&token===WEBHOOK_VERIFY_TOKEN?(console.log('✅ Webhook verificado'),s.status(200).send(challenge)):s.sendStatus(403)});app.post('/webhook',async(q,s)=>{try{const body=q.body;if(body.object==='whatsapp_business_account'){body.entry.forEach(e=>{e.changes.forEach(c=>{if(c.value.messages){const message=c.value.messages[0];const from=message.from;const text=message.text.body.toUpperCase().trim();console.log(`📱 Mensaje de ${from}: ${text}`);procesarComando(from,text,q)}})})}s.sendStatus(200)}catch(error){console.error('❌ Error:',error);s.sendStatus(500)}});function procesarComando(t,c,q){if(c==='ENTRAR'||c==='SALIR'){const clientIP=getClientIP(q);console.log(`🔍 Fichaje - ${t}, IP: ${clientIP}, ${c}`);if(!isInCompanyWiFi(clientIP)){const mensaje='🚫 *Fichaje bloqueado*\\n\\nSolo desde WiFi empresa.\\n\\n'+`Tu IP: ${clientIP}\\nConéctate al WiFi.`;sendWhatsAppMessage(t,mensaje);console.log(`🚫 RECHAZADO - ${t}`);return}registrarAccion(t,c,clientIP,(e,r)=>{if(e){console.error('Error:',e);sendWhatsAppMessage(t,'❌ Error al registrar.');return}const fecha=new Date(r.fecha_hora).toLocaleString('es-ES');const emoji=c==='ENTRAR'?'✅':'🚪';const mensaje=`${emoji} *${c}* registrado\\n📅 ${fecha}\\n📍 IP: ${clientIP}`;sendWhatsAppMessage(t,mensaje);console.log(`✅ EXITOSO - ${t} - ${c}`)})}else if(c==='WIFI'){const clientIP=getClientIP(q);const enRed=isInCompanyWiFi(clientIP);const emoji=enRed?'✅':'❌';const estado=enRed?'conectado':'NO conectado';const mensaje=`${emoji} *Estado WiFi*\\n\\nEstás ${estado} a la red.\\n\\nIP: ${clientIP}`;sendWhatsAppMessage(t,mensaje)}else if(c==='CONSULTA'){consultarRegistrosHoy(t)}else if(c.startsWith('MES ')){const mes=c.replace('MES ','').trim();consultarRegistrosMes(t,mes)}else if(c==='AYUDA'){enviarAyuda(t)}else{sendWhatsAppMessage(t,'❓ Comando no reconocido. *AYUDA*')}}function consultarRegistrosHoy(t){const hoy=new Date().toISOString().split('T')[0];obtenerRegistrosUsuario(t,null,(e,r)=>{if(e){sendWhatsAppMessage(t,'❌ Error.');return}const registrosHoy=r.filter(x=>x.fecha_hora.startsWith(hoy));if(registrosHoy.length===0){sendWhatsAppMessage(t,'📋 Sin registros hoy.');return}let mensaje='📋 *Registros hoy:*\\n\\n';registrosHoy.forEach(x=>{const hora=new Date(x.fecha_hora).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});mensaje+=`${x.accion==='ENTRAR'?'✅':'🚪'} ${x.accion} - ${hora}\\n`});sendWhatsAppMessage(t,mensaje)})}function consultarRegistrosMes(t,m){obtenerRegistrosUsuario(t,m,(e,r)=>{if(e||r.length===0){sendWhatsAppMessage(t,`📋 Sin registros en ${m}`);return}let mensaje=`📋 *Registros ${m}:*\\n\\n`;r.slice(0,10).forEach(x=>{const fecha=new Date(x.fecha_hora).toLocaleDateString('es-ES');mensaje+=`${x.accion==='ENTRAR'?'✅':'🚪'} ${x.accion} - ${fecha}\\n`});mensaje+=`\\n📊 Total: ${r.length}`;sendWhatsAppMessage(t,mensaje)})}function enviarAyuda(t){const mensaje=`🤖 *A DIARIO*\n*Comandos:*\n✅ *ENTRAR*\n🚪 *SALIR*\n📋 *CONSULTA*\n📅 *MES 2025-12*\n📶 *WIFI*\n❓ *AYUDA*\n⚠️ Solo WiFi empresa`.trim();sendWhatsAppMessage(t,mensaje)}async function sendWhatsAppMessage(to,text){try{await axios.post(`https://graph.facebook.com/v21.0/${PHONE_NUMBER_ID}/messages`,{messaging_product:'whatsapp',to:to,text:{body:text}},{headers:{'Authorization':`Bearer ${WHATSAPP_TOKEN}`,'Content-Type':'application/json'}});console.log(`✉️ Mensaje a ${to}`)}catch(error){console.error('❌ Error:',error.response?.data||error.message)}}const PORT=process.env.PORT||3000;app.listen(PORT,()=>{console.log(`🚀 A DIARIO en puerto ${PORT}`);console.log(`🔒 WiFi: ${process.env.ALLOWED_IPS}`)});
