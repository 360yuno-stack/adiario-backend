<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fichar - A DIARIO</title><style>*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif}body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:500px;margin:0 auto}.card{background:white;padding:30px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.2);margin-bottom:20px}.header{text-align:center;margin-bottom:30px}h1{color:#333;font-size:32px;margin-bottom:5px}.subtitle{color:#666}.user-info{background:#f0f4ff;padding:15px;border-radius:8px;text-align:center;margin-bottom:20px}.user-name{font-size:20px;color:#333;font-weight:600}.status{padding:15px;border-radius:8px;margin-bottom:20px;text-align:center}.status.wifi-ok{background:#d4edda;color:#155724}.status.wifi-error{background:#f8d7da;color:#721c24}.buttons{display:grid;gap:15px;margin-bottom:20px}.btn{padding:20px;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s}.btn:active{transform:scale(0.95)}.btn-entrar{background:#28a745;color:white;box-shadow:0 4px 15px rgba(40,167,69,0.3)}.btn-entrar:hover{background:#218838}.btn-salir{background:#dc3545;color:white;box-shadow:0 4px 15px rgba(220,53,69,0.3)}.btn-salir:hover{background:#c82333}.registros{background:#f9fafb;padding:15px;border-radius:8px;max-height:300px;overflow-y:auto}.registro-item{padding:10px;background:white;margin-bottom:8px;border-radius:6px;display:flex;justify-content:space-between;align-items:center}.registro-tipo{font-weight:600}.tipo-entrar{color:#28a745}.tipo-salir{color:#dc3545}.loading{text-align:center;color:#666;padding:20px}</style></head><body><div class="container"><div class="card"><div class="header"><h1> A DIARIO</h1><p class="subtitle">Control de Fichaje</p></div><div class="user-info"><div class="user-name" id="userName">Cargando...</div></div><div class="status" id="wifiStatus">Verificando WiFi...</div><div class="buttons"><button class="btn btn-entrar" id="btnEntrar"> ENTRAR</button><button class="btn btn-salir" id="btnSalir"> SALIR</button></div><div class="card"><h3 style="margin-bottom:15px"> Fichajes de Hoy</h3><div class="registros" id="registros"><div class="loading">Cargando...</div></div></div></div></div><script>const token=window.location.pathname.split('/')[2];async function verificarToken(){try{const r=await fetch(`/api/empleado/verificar/${token}`);const d=await r.json();if(d.ok){document.getElementById('userName').textContent=d.usuario.nombre}else{document.getElementById('userName').textContent=' Token inválido';document.querySelectorAll('.btn').forEach(b=>b.disabled=true)}}catch(e){console.error(e)}}async function verificarWiFi(){try{const r=await fetch('/api/wifi');const d=await r.json();const status=document.getElementById('wifiStatus');if(d.allowed){status.className='status wifi-ok';status.textContent=` Conectado a WiFi empresa (IP: ${d.ip})`}else{status.className='status wifi-error';status.textContent=` No estás en la red de la empresa (IP: ${d.ip})`}}catch(e){console.error(e)}}async function fichar(tipo){try{const r=await fetch('/api/fichar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,token})});const d=await r.json();if(d.ok){alert(` ${tipo} registrado correctamente\n ${d.fecha}`);cargarRegistros();verificarWiFi()}else{alert(` ${d.error}`)}}catch(e){alert('Error de conexión')}}async function cargarRegistros(){try{const r=await fetch(`/api/hoy/${token}`);const d=await r.json();const lista=document.getElementById('registros');if(d.registros&&d.registros.length>0){lista.innerHTML=d.registros.map(reg=>`<div class="registro-item"><span class="registro-tipo ${reg.tipo==='ENTRAR'?'tipo-entrar':'tipo-salir'}">${reg.tipo==='ENTRAR'?'':''} ${reg.tipo}</span><span>${reg.hora}</span></div>`).join('')}else{lista.innerHTML='<p style="text-align:center;color:#666">Sin fichajes hoy</p>'}}catch(e){console.error(e)}}document.getElementById('btnEntrar').addEventListener('click',()=>fichar('ENTRAR'));document.getElementById('btnSalir').addEventListener('click',()=>fichar('SALIR'));verificarToken();verificarWiFi();cargarRegistros();setInterval(verificarWiFi,30000);</script></body></html>
