require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const axios = require('axios');
const cron = require('node-cron');
const nodemailer = require('nodemailer');
const PDFDocument = require('pdfkit');
const fs = require('fs');
const path = require('path');
const { registrarAccion, obtenerRegistrosUsuario, obtenerRegistrosMes, obtenerResumenMensual, obtenerAdministradores } = require('./database');
const { isInCompanyWiFi, getClientIP } = require('./wifi-validator');

const app = express();
app.use(bodyParser.json());

const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const PHONE_NUMBER_ID = process.env.PHONE_NUMBER_ID;
const WEBHOOK_VERIFY_TOKEN = process.env.WEBHOOK_VERIFY_TOKEN;

const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASSWORD
    }
});

// WEBHOOK VERIFICATION
app.get('/webhook', (req, res) => {
    const mode = req.query['hub.mode'];
    const token = req.query['hub.verify_token'];
    const challenge = req.query['hub.challenge'];
    
    if (mode === 'subscribe' && token === WEBHOOK_VERIFY_TOKEN) {
        console.log(' Webhook verificado');
        res.status(200).send(challenge);
    } else {
        res.sendStatus(403);
    }
});

// WEBHOOK MESSAGES
app.post('/webhook', async (req, res) => {
    try {
        const body = req.body;
        if (body.object === 'whatsapp_business_account') {
            body.entry.forEach(entry => {
                entry.changes.forEach(change => {
                    if (change.value.messages) {
                        const message = change.value.messages[0];
                        const from = message.from;
                        const text = message.text.body.toUpperCase().trim();
                        console.log(\ Mensaje de \: \\);
                        procesarComando(from, text, req);
                    }
                });
            });
        }
        res.sendStatus(200);
    } catch (error) {
        console.error(' Error procesando webhook:', error);
        res.sendStatus(500);
    }
});

function procesarComando(telefono, comando, req) {
    if (comando === 'ENTRAR' || comando === 'SALIR') {
        //  VALIDAR QUE ESTÉ EN WIFI EMPRESARIAL
        const clientIP = getClientIP(req);
        console.log(\ Intento de fichaje - Usuario: \, IP: \, Acción: \\);
        
        if (!isInCompanyWiFi(clientIP)) {
            const mensaje = ' *Fichaje bloqueado*\\n\\n' +
                'Solo puedes fichar desde la red WiFi de la empresa.\\n\\n' +
                \Tu IP actual: \\\n\ +
                'Conéctate al WiFi empresarial e intenta de nuevo.';
            sendWhatsAppMessage(telefono, mensaje);
            console.log(\ Fichaje rechazado para \ - IP: \ (fuera de red)\);
            return;
        }

        // Si está en WiFi correcto, proceder con el fichaje
        registrarAccion(telefono, comando, clientIP, (err, registro) => {
            if (err) {
                console.error('Error registrando acción:', err);
                sendWhatsAppMessage(telefono, ' Error al registrar. Intenta de nuevo.');
                return;
            }
            const fecha = new Date(registro.fecha_hora).toLocaleString('es-ES');
            const emoji = comando === 'ENTRAR' ? '' : '';
            const mensaje = \\ *\* registrado\\n \\\n IP: \\;
            sendWhatsAppMessage(telefono, mensaje);
            console.log(\ Fichaje exitoso - \ - \ - IP: \\);
        });
    } else if (comando === 'WIFI') {
        const clientIP = getClientIP(req);
        const enRed = isInCompanyWiFi(clientIP);
        const emoji = enRed ? '' : '';
        const estado = enRed ? 'conectado' : 'NO conectado';
        const mensaje = \\ *Estado de conexión*\\n\\n\ +
            \Estás \ a la red WiFi empresarial.\\n\\n\ +
            \Tu IP actual: \\;
        sendWhatsAppMessage(telefono, mensaje);
    } else if (comando === 'CONSULTA') {
        consultarRegistrosHoy(telefono);
    } else if (comando.startsWith('MES ')) {
        const mes = comando.replace('MES ', '').trim();
        consultarRegistrosMes(telefono, mes);
    } else if (comando === 'AYUDA') {
        enviarAyuda(telefono);
    } else {
        sendWhatsAppMessage(telefono, ' Comando no reconocido. Envía *AYUDA* para ver los comandos.');
    }
}

function consultarRegistrosHoy(telefono) {
    const hoy = new Date().toISOString().split('T')[0];
    obtenerRegistrosUsuario(telefono, null, (err, registros) => {
        if (err) {
            sendWhatsAppMessage(telefono, ' Error al consultar registros.');
            return;
        }
        const registrosHoy = registros.filter(r => r.fecha_hora.startsWith(hoy));
        if (registrosHoy.length === 0) {
            sendWhatsAppMessage(telefono, ' No tienes registros hoy.');
            return;
        }
        let mensaje = ' *Registros de hoy:*\\n\\n';
        registrosHoy.forEach(r => {
            const hora = new Date(r.fecha_hora).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            mensaje += \\ \ - \\\n\;
        });
        sendWhatsAppMessage(telefono, mensaje);
    });
}

function consultarRegistrosMes(telefono, mesAno) {
    obtenerRegistrosUsuario(telefono, mesAno, (err, registros) => {
        if (err || registros.length === 0) {
            sendWhatsAppMessage(telefono, \ No tienes registros en \.\);
            return;
        }
        let mensaje = \ *Registros de \:*\\n\\n\;
        registros.slice(0, 10).forEach(r => {
            const fecha = new Date(r.fecha_hora).toLocaleDateString('es-ES');
            mensaje += \\ \ - \\\n\;
        });
        mensaje += \\\n Total: \ registros\;
        sendWhatsAppMessage(telefono, mensaje);
    });
}

function enviarAyuda(telefono) {
    const mensaje = \
 *Sistema de Control Horario A DIARIO*

*Comandos disponibles:*
 *ENTRAR* - Registrar entrada
 *SALIR* - Registrar salida
 *CONSULTA* - Ver registros de hoy
 *MES 2025-12* - Ver registros del mes
 *WIFI* - Verificar tu conexión
 *AYUDA* - Ver este mensaje

 *IMPORTANTE:* 
Solo puedes fichar ENTRAR/SALIR desde la red WiFi de la empresa.

Los demás comandos funcionan desde cualquier lugar.
    \.trim();
    sendWhatsAppMessage(telefono, mensaje);
}

async function sendWhatsAppMessage(to, text) {
    try {
        await axios.post(
            \https://graph.facebook.com/v21.0/\/messages\,
            {
                messaging_product: 'whatsapp',
                to: to,
                text: { body: text }
            },
            {
                headers: {
                    'Authorization': \Bearer \\,
                    'Content-Type': 'application/json'
                }
            }
        );
        console.log(\ Mensaje enviado a \\);
    } catch (error) {
        console.error(' Error enviando mensaje:', error.response?.data || error.message);
    }
}

// API ENDPOINTS
app.get('/', (req, res) => {
    res.send('<h1>A DIARIO - Sistema de Control Horario</h1><p> Servidor activo</p>');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(\ Servidor A DIARIO corriendo en puerto \\);
    console.log(\ Webhook activo en /webhook\);
    console.log(\ Validación WiFi empresarial activada\);
    console.log(\ Red permitida: \\);
});
