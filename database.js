const sqlite3=require('sqlite3').verbose();const path=require('path');const db=new sqlite3.Database(path.join(__dirname,'horarios.db'),(e)=>{e?console.error('❌ Error:',e):console.log('✅ Conectado SQLite')});db.run(`CREATE TABLE IF NOT EXISTS usuarios(id INTEGER PRIMARY KEY AUTOINCREMENT,telefono TEXT UNIQUE NOT NULL,nombre TEXT,email TEXT,token TEXT UNIQUE NOT NULL,activo BOOLEAN DEFAULT 1,creado_en DATETIME DEFAULT CURRENT_TIMESTAMP)`);db.run(`CREATE TABLE IF NOT EXISTS registros(id INTEGER PRIMARY KEY AUTOINCREMENT,telefono TEXT NOT NULL,accion TEXT,fecha_hora DATETIME DEFAULT CURRENT_TIMESTAMP,ip TEXT)`);function registrarAccion(t,a,i,c){db.run('INSERT INTO registros(telefono,accion,ip)VALUES(?,?,?)',[t,a,i],function(e){if(e)return c(e);db.get('SELECT*FROM registros WHERE id=?',[this.lastID],c)})}function obtenerRegistrosUsuario(t,m,c){let s='SELECT*FROM registros WHERE telefono=?';const p=[t];if(m){s+=" AND strftime('%Y-%m',fecha_hora)=?";p.push(m)}s+=' ORDER BY fecha_hora DESC';db.all(s,p,c)}function obtenerRegistrosMes(m,c){db.all("SELECT*FROM registros WHERE strftime('%Y-%m',fecha_hora)=? ORDER BY fecha_hora DESC",[m],c)}function obtenerResumenMensual(t,m,c){db.all("SELECT DATE(fecha_hora)as fecha,COUNT(*)as total_registros FROM registros WHERE telefono=? AND strftime('%Y-%m',fecha_hora)=? GROUP BY DATE(fecha_hora)ORDER BY fecha",[t,m],c)}function crearUsuario(t,n,e,k,c){db.run('INSERT INTO usuarios(telefono,nombre,email,token)VALUES(?,?,?,?)',[t,n,e,k],function(e){if(e)return c(e);db.get('SELECT*FROM usuarios WHERE id=?',[this.lastID],c)})}function obtenerUsuarioPorToken(t,c){db.get('SELECT*FROM usuarios WHERE token=? AND activo=1',[t],c)}function obtenerTodosUsuarios(c){db.all('SELECT id,telefono,nombre,email,token,activo,creado_en FROM usuarios ORDER BY creado_en DESC',c)}module.exports={registrarAccion,obtenerRegistrosUsuario,obtenerRegistrosMes,obtenerResumenMensual,crearUsuario,obtenerUsuarioPorToken,obtenerTodosUsuarios};
